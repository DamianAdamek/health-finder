@startuml Edit Personal Data Sequence Diagram
!theme plain
skinparam backgroundColor #FEFEFE
skinparam maxMessageSize 150

title Diagram sekwencji: Edycja danych personalnych użytkownika

actor "Użytkownik" as User
participant "ProfilePage" as Frontend
participant "Controller" as Controller
participant "UserManagement\nService" as Service
participant "Recommendation\nService" as RecommendationSvc
database "Database" as DB

== Basic Flow ==

User -> Frontend: 1. Loguje się i wybiera\n"Mój profil" → "Edytuj dane"

Frontend -> Controller: GET /users/me
Controller -> Service: findOneUser(userId)
Service -> DB: SELECT user data
DB --> Service: User profile
Service --> Controller: UserProfile
Controller --> Frontend: 200 OK

Frontend --> User: 2. Wyświetla formularz\nz obecnymi danymi

User -> Frontend: 3. Wprowadza zmiany\n(adres, telefon, preferencje)

User -> Frontend: 4. Klika "Zapisz"

Frontend -> Controller: PATCH /clients/me\n{city, zipCode, street, contactNumber...}

Controller -> Controller: 5. Walidacja danych\n(formaty, wymagane pola)

alt Walidacja pomyślna
    Controller -> Service: updateClient(clientId, dto)
    
    Service -> DB: SELECT current client data
    DB --> Service: Client with old location
    
    Service -> DB: UPDATE user data\n(firstName, lastName, contactNumber)
    Service -> DB: UPDATE/INSERT location\n(city, zipCode, street, buildingNumber)
    DB --> Service: Updated
    
    Service -> Service: 6. Porównuje lokalizację\n(stara vs nowa)
    
    alt Lokalizacja uległa zmianie
        note right of Service
            7. System wykrywa zmianę lokalizacji
        end note
        
        Service -> RecommendationSvc: 8. (Include) recomputeRecommendations\nForClient(clientId)
        activate RecommendationSvc
        
        note right of RecommendationSvc
            **Use Case: Wyszukaj propozycje treningów**
            • Pobiera lokalizację i formularz klienta
            • Geokoduje adres (LocationService + Nominatim API)
            • Filtruje treningi wg typu i dostępności
            • Oblicza odległości do siłowni
            • Sortuje i zwraca top 10 rekomendacji
        end note
        
        RecommendationSvc -> DB: Pobiera treningi,\nsiłownie, lokalizacje
        DB --> RecommendationSvc: Training data
        
        alt Sukces - znaleziono dopasowania
            RecommendationSvc --> Service: RecommendedTraining[]
            deactivate RecommendationSvc
            
        else Brak dopasowań (Alt 5.4)
            RecommendationSvc --> Service: [] (pusta lista)
            deactivate RecommendationSvc
            note right of Service: System informuje o braku\ndopasowań w okolicy
            
        else Błąd usługi lokalizacji (Alt 5.3)
            RecommendationSvc --> Service: Error (catch)
            deactivate RecommendationSvc
            note right of Service: Dane zapisane, ale błąd\ngeokodowania - proponuje retry
        end
    end
    
    Service -> DB: SELECT updated client
    DB --> Service: Updated Client
    
    Service --> Controller: Updated Client
    Controller --> Frontend: 200 OK
    
    Frontend --> User: 9. Potwierdzenie "Dane zapisane"\n+ zaktualizowane rekomendacje
    
else Błąd walidacji (Alt 5.2)
    Controller --> Frontend: 400 Bad Request\n{errors: [...]}
    Frontend --> User: Komunikat o błędach\ndo poprawy
    note right of User: Użytkownik poprawia\ni wraca do kroku 4
end

== Alternative Flow 5.1: Anulowanie ==

User -> Frontend: Wybiera "Anuluj"
Frontend --> User: Powrót do profilu\n(bez zapisu)

@enduml
